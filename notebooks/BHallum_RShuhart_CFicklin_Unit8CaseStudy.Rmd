---
title: "Modeling Runners' Times in the Cherry Blossom Race"
author: "Brett Hallum, Chris Ficklin, and Ryan Shuhart"
date: "March 2017"
output:
  html_notebook: default
  html_document: default
  pdf_document: default
subtitle: MSDS 7333-401
---

<font color = "green">
### [Temporary]
Q.10 We have seen that the 1999 runners were typically older than the 2012 runners.
Compare the age distribution of the runners across all 14 years of the races. Use
quantile plots, boxplots, and density curves to make your comparisons. How do the
distributions change over the years? Was it a gradual change?

#### Other idea to possibly explore:
* Did the same drop in the age distibution occur for both male and female?

* Did the younger generation participation grow faster than older groups?
    * Plot median age by generation
</font>



```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
require(gridExtra)
```

```{r}
# This functions categorizes the age of runners in to defined birthed generations
# Generation definition source: http://genhq.com/faq-info-about-generations/
find_gen <- function(Age, Year) {
  birth_year <- Year - Age
  if_else(birth_year >= 1996, "Gen Z",
          if_else(birth_year >= 1997, "Gen Y",
                  if_else(birth_year >= 1965, "Gen X",
                          if_else(birth_year >= 1946, "Boomer",
                                  if_else(birth_year < 1946, "Silent", "Unknown")))))
}

# Select 1999-2012 data and make a few transformations
run_data <- readRDS("../data/processed/processed_run_data_1990-2016.rds") %>%
  filter(Year %in% c(1999:2016)) %>%
  select(Name, Sex, Age, Event, Year, Division, TimeInMin, PaceInMin) %>%
  mutate(Sex = as.factor(Sex),
         Event = as.factor(Event),
         Division = as.factor(Division),
         Generation = ordered(find_gen(Age, Year), 
                              levels= c("Unknown", "Silent", "Boomer", 
                                        "Gen X", "Gen Y", "Gen Z")),
         AgeCat = cut(Age, breaks= c(seq(15, 75, 10), 90)))


str(run_data)
```


# Introduction


# Background


# Methods


# Results 

## Distribution of Age Over Years 1999 to 2016
```{r}
median_age <- group_by(run_data, Year) %>%
  summarize(Med_Age = median(Age, na.rm = TRUE))

median_age_line <- ggplot(median_age, aes(x=Year, y=Med_Age)) + 
  geom_line() + 
  labs(title=paste("Median Age Between ", min(median_age$Year), " - ", max(median_age$Year), sep=""))
```

```{r, fig.height=5, fig.width=11}
generation_plot <- ggplot(run_data[!is.na(run_data$Generation),], aes(Year, fill=Generation, color=Generation)) + 
  geom_bar(position="fill", width = 1) +
  scale_y_continuous(labels = scales::percent) +
  labs(title="Generational Proportions by Year")
  
grid.arrange(median_age_line, generation_plot, ncol=2)
```


```{r}
ggplot(run_data, aes(Year, fill=AgeCat)) + geom_bar(position="fill") 
```

```{r, fig.height=8, fig.width=8, warning=FALSE}

male_data = filter(run_data, Sex == "M")
fem_data = filter(run_data, Sex == "W")

m_plot <- ggplot(male_data, aes(x=TimeInMin, y=Age))  +
  geom_point() + 
  stat_density_2d(geom = "raster", aes(fill = ..density..), contour = FALSE) + 
  scale_fill_distiller(palette = "Spectral") +
  xlim(40, 180) +
  ylim(0,100) +
  labs(title="Male Runners - Age vs Time")

f_plot <- ggplot(fem_data, aes(x=TimeInMin, y=Age))  +
  geom_point() + 
  stat_density_2d(geom = "raster", aes(fill = ..density..), contour = FALSE) + 
  scale_fill_distiller(palette = "Spectral") +
  xlim(40, 180)+
  ylim(0,100)

grid.arrange(m_plot, f_plot, nrow=2)
```


```{r}
ggplot(male_data, aes(x=Year, y=Age))  +
  geom_point() + 
  stat_density_2d(geom = "raster", aes(fill = ..density..), contour = FALSE) + 
  scale_fill_distiller(palette = "Spectral") +
  ylim(0,100)
```
```{r}
ggplot(fem_data, aes(x=Year, y=Age))  +
  geom_point() + 
  stat_density_2d(geom = "raster", aes(fill = ..density..), contour = FALSE) + 
  scale_fill_distiller(palette = "Spectral") +
  ylim(0,100)
```


```{r}
ggplot(male_data, aes(Age, color = as.factor(Year))) +
  geom_density()
  
```

```{r}
ggplot(fem_data, aes(Age, color = as.factor(Year))) +
  geom_density()
  
```

```{r}
## Create a plot of median age data after fitting a linear model
lmfit <- lm(Med_Age ~ Year, data = median_age)
plotdata <- ggplot(data = median_age, aes(x=Year, y=Med_Age))+
  ggtitle("Median Age")+
  geom_point(size=3)+
  geom_abline(intercept = coef(lmfit)[1], slope = coef(lmfit)[2])
plotdata
```
```{r}
## Add a variable for a known change point at 2010
## Corresponding to the known change to the lottery registration format which eliminated the first-come, first-serve factor
median_age$cp2010 <- pmax(0, median_age$Year-2010)
median_age$Year
median_age$cp2010
```
```{r}
## Fit the known change point model
cp2010.fit <- lm(Med_Age ~ Year +cp2010, data = median_age)
summary(cp2010.fit)
```
The p-value for cp2010 is highly significant, suggesting that there was a change to the slope representing median age occurring in 2010, the same year as the registration format changed.

Additionally, the highly significant p-value for Year rejects the hypothesis that the slope is (1 or horizontal, I need to check that out)


# Conclusion































