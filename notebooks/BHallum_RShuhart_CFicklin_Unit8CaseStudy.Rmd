---
title: "Modeling Runners' Times in the Cherry Blossom Race - Question 10"
author: "Brett Hallum, Chris Ficklin, and Ryan Shuhart"
date: "March 2017"
output:
  html_notebook: default
  html_document: default
  pdf_document: default
subtitle: MSDS 7333-401
---

<font color = "green">
### [Temporary]
Q.10 We have seen that the 1999 runners were typically older than the 2012 runners.
Compare the age distribution of the runners across all 14 years of the races. Use
quantile plots, boxplots, and density curves to make your comparisons. How do the
distributions change over the years? Was it a gradual change?
</font>

#### Outline for Planning Purposes
* Introduction
* Background
    + History of Blossom Race
    + Registration problem occurred
    + Time to close registration
    + Introduction of lottery
* Methods
    + Data gathering process via web scrapping
        - Scraped searchable results site between 1999-2016
        - Gathered time of registration from web.archive.org
    + Discription of data
        - Variable names and description used in analysis
* Results 
    + Age Distribution between 1999-2016 [or wider range]
    + Changepoint analysis
* Conclusion



```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
require(gridExtra)
```

```{r}
# This functions categorizes the age of runners in to defined birthed generations
# Generation definition source: http://genhq.com/faq-info-about-generations/
find_gen <- function(Age, Year) {
  birth_year <- Year - Age
  if_else(birth_year >= 1996, "Gen Z",
          if_else(birth_year >= 1997, "Gen Y",
                  if_else(birth_year >= 1965, "Gen X",
                          if_else(birth_year >= 1946, "Boomer",
                                  if_else(birth_year < 1946, "Silent", "Unknown")))))
}

# Select 1999-2012 data and make a few transformations
run_data <- readRDS("../data/processed/processed_run_data_1990-2016.rds")
run_data <- rbind(run_data, readRDS("../data/processed/processed_run_data_1973-1989.rds"))
run_data <- run_data %>%
  #filter(Year %in% c(1999:2016)) %>%
  select(Name, Sex, Age, Event, Year, Division, TimeInMin, PaceInMin) %>%
  mutate(Sex = as.factor(Sex),
         Event = as.factor(Event),
         Division = as.factor(Division),
         Generation = ordered(find_gen(Age, Year), 
                              levels= c("Unknown", "Silent", "Boomer", 
                                        "Gen X", "Gen Y", "Gen Z")),
         AgeCat = cut(Age, breaks= c(seq(15, 75, 10), 90)))


str(run_data)
```


# Introduction


# Background


# Methods


# Results 

## Distribution of Age Over Years 1999 to 2016
```{r, fig.height=5, fig.width=11}
runner_count <- group_by(run_data, Year) %>% summarize(Runner_Count = n())

median_age <- group_by(run_data, Year) %>%
  summarize(Med_Age = median(Age, na.rm = TRUE))

median_age_line <- ggplot(median_age, aes(x=Year, y=Med_Age)) + 
  geom_line(size = 1.25) + 
  labs(title=paste("Median Age Between ", min(median_age$Year), " - ", max(median_age$Year), sep=""))

median_age_by_sex <- group_by(run_data, Year, Sex) %>%
  summarize(Med_Age = median(Age, na.rm = TRUE))

median_age_by_sex_line <- ggplot(median_age_by_sex, aes(x=Year, y=Med_Age, color = Sex)) + 
  geom_line(size = 1.25) + 
  scale_color_manual(values=c("#1D829F","#DF438A")) +
  labs(title=paste("Median Age by Sex Between ", min(median_age$Year), " - ", max(median_age$Year), sep=""))

  
grid.arrange(median_age_line, median_age_by_sex_line, ncol=2)
```


```{r}
ggplot(run_data, aes(Year, fill=AgeCat)) + geom_bar(position="fill", width=1) 
```


```{r}
male_data = filter(run_data, Sex == "M")
fem_data = filter(run_data, Sex == "W")

ggplot(male_data, aes(x=Year, y=Age))  +
  geom_point() + 
  stat_density_2d(geom = "raster", aes(fill = ..density..), contour = FALSE) + 
  scale_fill_distiller(palette = "Spectral") +
  ylim(0,100)
```
```{r}
ggplot(fem_data, aes(x=Year, y=Age))  +
  geom_point() + 
  stat_density_2d(geom = "raster", aes(fill = ..density..), contour = FALSE) + 
  scale_fill_distiller(palette = "Spectral") +
  ylim(0,100)
```


```{r}
ggplot(male_data, aes(Age, color = as.factor(Year))) +
  geom_density()
  
```

```{r}
ggplot(fem_data, aes(Age, color = as.factor(Year))) +
  geom_density()
  
```

```{r}
## Create a plot of median age data after fitting a linear model
lmfit <- lm(Med_Age ~ Year, data = median_age)
plotdata <- ggplot(data = median_age, aes(x=Year, y=Med_Age))+
  ggtitle("Median Age")+
  geom_point(size=3)+
  geom_abline(intercept = coef(lmfit)[1], slope = coef(lmfit)[2])
plotdata
```
```{r}
## Add a variable for a known change point at 2010
## Corresponding to the known change to the lottery registration format which eliminated the first-come, first-serve factor
median_age$cp2010 <- pmax(0, median_age$Year-2010)
median_age$Year
median_age$cp2010
```
```{r}
## Fit the known change point model
cp2010.fit <- lm(Med_Age ~ Year +cp2010, data = median_age)
summary(cp2010.fit)
```
The p-value for cp2010 is highly significant, suggesting that there was a change to the slope representing median age occurring in 2010, the same year as the registration format changed.

Additionally, the highly significant p-value for Year rejects the hypothesis that the slope is (1 or horizontal, I need to check that out)



# Conclusion































